#!/usr/bin/env node
import y from"fs";import v from"path";import{google as P}from"googleapis";import R from"yargs";import{hideBin as N}from"yargs/helpers";const u=(...i)=>console.log("[INFO]",...i),o=(...i)=>console.error("[ERROR]",...i);function x(i){return i.replace(/[^a-zA-Z0-9_]/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"")}function J(i){let n="";for(;i>=0;)n=String.fromCharCode(65+i%26)+n,i=Math.floor(i/26)-1;return n}function _(i){return i?i.split(",").map(n=>n.trim()).filter(Boolean).map(n=>{try{return new RegExp(n)}catch{return o(`Invalid ignore pattern "${n}", skipping`),null}}).filter(n=>n!==null):[]}async function I(i,n,l=[]){var h;const r=P.sheets({version:"v4",auth:i});let e;try{e=await r.spreadsheets.get({spreadsheetId:n})}catch(p){const g=p&&p.response&&p.response.status;g===403?(o("Google Sheets API returned 403 (forbidden)."),o("Please make sure the spreadsheet is shared with the service account"),o("from your credentials.json (at least Viewer access).")):g===404?(o("Google Sheets API returned 404 (not found)."),o("Please verify the --sheet (spreadsheetId) argument is correct.")):o(`Error fetching spreadsheet metadata: ${p}`),process.exit(1)}const t=(h=e.data.sheets)!==null&&h!==void 0?h:[],f=[];let c=0,$=0,w=0;const a=Math.min(6,Math.max(1,t.length));async function d(){for(var p;;){const g=w++;if(g>=t.length)break;const m=(p=t[g].properties)===null||p===void 0?void 0:p.title;if(!m){o("Skipping sheet with missing title");continue}if(l.some(s=>s.test(m))){u(`Ignoring sheet "${m}" as it matches ignore patterns`),$++;continue}try{const S=(await r.spreadsheets.values.get({spreadsheetId:n,range:m})).data.values;if(!S||S.length<2||S[0].length<4){o(`Sheet "${m}" has insufficient data, skipping`),c++;continue}f.push({title:m,values:S})}catch(s){o(`Error fetching values for sheet "${m}": ${s}`)}}}const b=[];for(let p=0;p<a;p++)b.push(d());return await Promise.all(b),u(`Spreadsheet summary: total sheets=${t.length}, usable=${f.length}, ignored=${$}, insufficient=${c}`),f}async function E(i){var n;const l={};for(const{title:h,values:r}of i){const e=x(h);l[e]={};const t=r[0],f=[];for(let a=3;a<t.length;a++){const d=t[a];if(typeof d=="string"&&d.trim()){const b=x(d);l[e][b]={},f[a]=b}else o(`Invalid locale header at column ${J(a)}, ignoring`),f[a]=null}let c=0,$=0,w=0;for(let a=1;a<r.length;a++){const d=r[a]||[];if(d.length===0||d.every(s=>s==null||String(s).trim()==="")){o(`Sheet "${h}" has empty row ${a+1}, skipping`),c++;continue}if(d.length<3){o(`Sheet "${h}" has row ${a+1} with less than 3 base columns, skipping`),c++;continue}const b=d[0];if(typeof b!="string"||!b.trim()){o(`Empty label at row ${a+1}, skipping`),$++;continue}const p=x(b),g=(n=d[2])!==null&&n!==void 0?n:"";let k=null,m=null;if(typeof g=="string"){const s=g.trim();if(s.startsWith("{")&&s.endsWith("}"))try{k=JSON.parse(s)}catch{o(`Invalid JSON in meta at row ${a+1}`)}else s.length>0&&(m=s)}for(let s=3;s<t.length;s++){const S=f[s];if(!S)continue;const j=d.length>s?d[s]:"",O=j!=null?String(j):"";l[e][S][p]=O,k&&Object.keys(k).length?l[e][S][`@${p}`]=k:m&&(l[e][S][`@${p}`]=m)}w++}u(`Sheet "${h}" summary: processed=${w}, skippedEmptyRows=${c}, skippedEmptyLabels=${$}`)}return l}async function F(i,n,l,h,r,e,t){y.existsSync(n)||(u(`Creating output directory: ${n}`),y.mkdirSync(n,{recursive:!0}));let f=0,c=0;for(const[$,w]of Object.entries(i)){const a=v.join(n,$);y.existsSync(a)||(u(`Creating directory: ${a}`),y.mkdirSync(a,{recursive:!0}));for(const[d,b]of Object.entries(w)){const p=`${l?l+"_":""}${d}.json`,g=v.join(a,p),k=Object.assign(Object.assign({"@@locale":d,"@@author":r??"","@@comment":e??"","@@context":t??""},h),b),m=JSON.stringify(k,null,2);if(y.existsSync(g))try{const j=y.readFileSync(g,"utf8"),O=JSON.parse(j);if(delete O["@@last_modified"],JSON.stringify(O,null,2)===m){u(`JSON file is up to date, skipping rewrite: ${g}`),c++;continue}}catch{}const s=Object.assign(Object.assign({"@@locale":d,"@@author":r??"","@@last_modified":new Date().toISOString(),"@@comment":e??"","@@context":t??""},h),b),S=JSON.stringify(s,null,2)+`
`;y.writeFileSync(g,S,"utf8"),u(`Written ${g}`),f++}}u(`JSON write summary: written=${f}, skippedUpToDate=${c}`)}async function G(i,n){const l=v.join(i,"index.ts"),h=y.readdirSync(i,{withFileTypes:!0}).filter(t=>t.isDirectory()).map(t=>t.name),r="locales",e=["// This file is generated, do not edit it manually!","",`export const ${r}: Record<string, Record<string, () => Promise<{ default: any }>>> = {`];for(const t of h){e.push(`  '${t}': {`);const f=y.readdirSync(v.join(i,t)).filter(c=>c.endsWith(".json"));for(const c of f){const $=c.replace(new RegExp(`^${n}_?`),"").replace(/\.json$/,"");e.push(`    '${$}': () => import('./${t}/${c}'),`)}e.push("  },")}e.push("};",""),e.push("/**"," * Load all locales at once."," * @returns Promise<Record<string, Record<string, any>>>"," */"),e.push("export async function loadLocales(): Promise<Record<string, Record<string, any>>> {"),e.push("  const result: Record<string, Record<string, any>> = {};"),e.push(`  const buckets = Object.keys(${r}) as string[];`),e.push(`  const localeKeys = Object.keys(${r}[buckets[0]]) as string[];`),e.push(""),e.push("  for (const locale of localeKeys) {"),e.push("    const entries = await Promise.all("),e.push(`      buckets.map(bucket => ${r}[bucket][locale]().then(m => [bucket, (m as any).default] as const))`),e.push("    );"),e.push("    result[locale] = Object.fromEntries(entries);"),e.push("  }"),e.push(""),e.push("  return result;"),e.push("}"),await y.promises.writeFile(l,e.join(`
`),"utf8"),u(`Written TypeScript locale index at ${l}`)}async function C(i,n){const l=v.join(i,"index.js"),h=y.readdirSync(i,{withFileTypes:!0}).filter(t=>t.isDirectory()).map(t=>t.name),r="locales",e=["// This file is generated, do not edit it manually!","",`export const ${r} = {`];for(const t of h){e.push(`  '${t}': {`);const f=y.readdirSync(v.join(i,t)).filter(c=>c.endsWith(".json"));for(const c of f){const $=c.replace(new RegExp(`^${n}_?`),"").replace(/\.json$/,"");e.push(`    '${$}': () => import('./${t}/${c}'),`)}e.push("  },")}e.push("};",""),e.push("/**"," * Load all locales at once."," * @returns Promise<Record<string, Record<string, any>>>"," */"),e.push("export async function loadLocales() {"),e.push("  const result: Record<string, Record<string, any>> = {};"),e.push(`  const buckets = Object.keys(${r});`),e.push(`  const localeKeys = Object.keys(${r}[buckets[0]]);`),e.push(""),e.push("  for (const locale of localeKeys) {"),e.push("    const entries = await Promise.all("),e.push(`      buckets.map(bucket => ${r}[bucket][locale]().then(m => [bucket, m.default]))`),e.push("    );"),e.push("    result[locale] = Object.fromEntries(entries);"),e.push("  }"),e.push(""),e.push("  return result;"),e.push("}"),y.writeFileSync(l,e.join(`
`),"utf8"),u(`Written JavaScript locale index at ${l}`)}const A=`
Localization Generator

Generate JSON files from Google Sheets.
This script uses the Google Sheets API to fetch
the localization table from a spreadsheet and generates JSON files for localization.
You need to create a service account and download the credentials JSON file.
You can find more information about how to create a service account here:
https://cloud.google.com/docs/authentication/getting-started#creating_a_service_account

Usage: node bin/generate.js [options]
`;async function W(){u("Reading command line arguments...");const i=R(N(process.argv)).scriptName("sheety-localization-generate").usage("Usage: $0 --credentials ./credentials.json --sheet <SPREADSHEET_ID> [options]").option("credentials",{alias:["c","key","keyfile","cred","creds","secret"],type:"string",demandOption:!0,describe:"Path to service account credentials JSON file",default:"credentials.json"}).option("sheet",{alias:["s","spreadsheet","spreadsheet-id","table","source","id"],type:"string",demandOption:!0,describe:"Google Spreadsheet ID"}).option("output",{alias:["o","out","dir"],type:"string",default:"src/locales",describe:"Output directory for generated locale files"}).option("prefix",{alias:["p","bucket-prefix"],type:"string",default:"",describe:"Prefix for locale file names (e.g. app_en.json)"}).option("meta",{alias:["m","global-meta"],type:"string",default:"{}",describe:"Global meta JSON string merged into every locale file"}).option("meta-file",{alias:["metaPath","meta-json"],type:"string",describe:"Path to JSON file with global meta (overrides --meta if provided)"}).option("type",{alias:["t","index-type"],choices:["js","ts"],default:"js",describe:"Type of generated index file (js or ts)"}).option("author",{type:"string",describe:"Author metadata stored under @@author"}).option("comment",{type:"string",describe:"Comment metadata stored under @@comment"}).option("context",{type:"string",describe:"Context metadata stored under @@context"}).option("ignore",{alias:["i","ignore-table","exclude","skip"],type:"string",default:"",describe:'Comma-separated list of RegExp patterns to ignore sheet titles (e.g. "help,backend-.*,temp-.*")'}).help("help").alias("help","h").epilog(A).parseSync(),{credentials:n,sheet:l,output:h,prefix:r,meta:e,metaFile:t,type:f,author:c,comment:$,context:w,ignore:a}=i;(!n||!l||!f)&&(o("Missing required arguments. Use --help for usage information."),process.exit(1));let d={};if(t)try{const s=y.readFileSync(t,"utf8");d=JSON.parse(s)}catch(s){o(`Failed to read meta from file "${t}": ${s}`)}else if(e)try{d=JSON.parse(e)}catch{o("Invalid --meta JSON")}u(`Credentials path: ${v.resolve(n)}`),y.existsSync(n)||(o(`Missing credentials file at ${n}`),process.exit(1)),u("Extracting credentials from file...");let b;try{b=JSON.parse(y.readFileSync(n,"utf8"))}catch(s){o(`Error reading credentials file: ${s}`),process.exit(1)}u("Creating Google Sheets API client...");let p;try{p=await new P.auth.GoogleAuth({credentials:b,scopes:["https://www.googleapis.com/auth/spreadsheets.readonly"]}).getClient()}catch(s){const S=s&&s.message?String(s.message):String(s);S.includes("invalid_grant")&&S.includes("Invalid JWT Signature")?(o("Error creating Google Sheets API client: invalid or revoked service account key in credentials.json."),o("The example credentials bundled with this project are not intended for real use."),o("Please create your own service account JSON in Google Cloud Console,"),o("download the key file, place it as example/credentials.json, and share your sheet"),o("with the service account email from that file (as Viewer or higher).")):o(`Error creating Google Sheets API client: ${s}`),process.exit(1)}u("Fetching spreadsheet data...");const g=_(a),k=await I(p,l,g);k.length||(o("No sheets found"),process.exit(1)),u(`Retrieving data from ${k.length} sheets...`),u("Building localization table...");const m=await E(k);u("Writing JSON files..."),await F(m,h,r,d,c,$,w),f==="ts"?(u("Generating index.ts..."),await G(h,r)):(u("Generating index.js..."),await C(h,r)),u(`Successfully generated localization files for ${Object.keys(m).length} buckets.`)}W().catch(i=>{o(i),process.exit(1)});
